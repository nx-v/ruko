# [PackageDev] target_format: plist, ext: tmLanguage
---
name: Sublime Text Syntax Def (YAML)
fileTypes: [
    tmLanguage.yml
    YAML-tmLanguage
    tmLanguage.yaml,
  ]
scopeName: source.yaml-tmlanguage
uuid: 6554be53-ae34-4f54-af28-751e2d80d4c0

patterns:
  ## first, match the global stuff
  - name: entity.other.document-start.yaml-tmlanguage
    match: ^---(?= |$)

  - name: entity.other.document-end.yaml-tmlanguage
    match: ^\.{3}$

  - name: invalid.illegal.tab-indent.yaml-tmlanguage
    match: ^\t+

  - include: '#comment'

  ## second, match content
  # in-repo
  - include: '#repository'

  # main scope
  - include: '#uuid'
  - include: '#name-main'
  - include: '#scope-name'
  - include: '#file-types'
  - include: '#author'
  - include: '#key-equivalent'
  - include: '#other-markers'
  - include: '#apply-end-pattern-last'

  # child scope
  - include: '#patterns'
  - include: '#captures'

  - include: '#name'
  - include: '#match'
  - include: '#include'
  - include: '#comment-from-key'
  - include: '#number-key'

  # the other remaining keys
  - include: '#repository-key-inline'

  # match for comments again after consuming the other sequences
  - include: '#comment'

  # unmatched but (probably) valid stuff
  - include: '#flow-style'
  - include: '#anchor'
  - include: '#alias'
  - include: '#unmatched'

# everything else should remain unmatched
# - include: '#illegal'

#######################################

repository:
  # control sequences
  comment:
    match: (?:^ *|\G *| +)((\#).*\n?)
    captures:
      1: {name: comment.line.number-sign.yaml-tmlanguage}
      2: {name: punctuation.definition.comment.line.yaml-tmlanguage}

  # special keys (main scope)
  uuid:
    name: meta.uuid.yaml-tmlanguage
    match: (?:,|\{ *|^)((["']?)(uuid|bundleUUID)(\2))(:) +((["']?)(\h{8}-\h{4}-\h{4}-\h{4}-\h{12})(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.uuid.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      # 6: {name: string.other.yaml-tmlanguage} # "string constant" is assigned by certain color schemes
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: constant.numeric.uuid.yaml-tmlanguage}
      9: {name: punctuation.definition.string.yaml-tmlanguage}

  name-main:
    # This one is allowed to contain nearly all characters instead of
    # the scope defining 'name' (not recognized in flow style, i.e. after ",")
    # Note: Please refuse to use " or ' in your syntax name, it makes things complicated
    name: meta.name-main.yaml-tmlanguage
    match: ^((["']?)(name)(\2))(:) +((["']?)[-\w\. ]*(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.name.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: entity.other.name.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: punctuation.definition.string.yaml-tmlanguage}

  scope-name:
    name: meta.scope-name.yaml-tmlanguage
    match: (?:,|\{ *|^)((["']?)(scopeName)(\2))(:) +((["']?)[-\w\. ]*(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.name.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage string.other.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: punctuation.definition.string.yaml-tmlanguage}

  file-types:
    patterns:
      # single-line
      - name: meta.file-types.yaml-tmlanguage
        begin: (?:, +|\{ *|^)((["']?)(fileTypes)(\2))(:) (\[)
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.name.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
          6: {name: keyword.control.list.opening-bracket.yaml-tmlanguage}
        end: \]
        endCaptures:
          0: {name: keyword.control.list.closing-bracket.yaml-tmlanguage}
        patterns:
          # items (in array)
          - match: (?:\G|^),? *((["']?)([-\w\._]+)(\2))(?=, |,$| +#| *\Z| *\])
            captures:
              1: {name: string.other.yaml-tmlanguage}
              2: {name: punctuation.definition.string.yaml-tmlanguage}
              3: {name: support.other.file-types.item.yaml-tmlanguage}
              4: {name: punctuation.definition.string.yaml-tmlanguage}
          - include: '#comment'

      # multi-line
      - name: meta.file-types.yaml-tmlanguage
        begin: (?:, +|\{ *|^)((["']?)(fileTypes)(\2))(:)(?= +#| *$)
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.name.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
        end: ^(?!$|-| *#)
        patterns:
          # multi-line items
          - match: ^- +((["']?)([-\w\. _]+)(\2))(?= +#| *$)
            captures:
              1: {name: string.other.yaml-tmlanguage}
              2: {name: punctuation.definition.string.yaml-tmlanguage}
              3: {name: support.other.file-types.item.yaml-tmlanguage}
              4: {name: punctuation.definition.string.yaml-tmlanguage}
          - include: '#comment'

  repository:
    patterns:
      # inline (who'd even use this?)
      # Note: probably broken with line breaks AFTER { or ,
      - name: meta.repository.yaml-tmlanguage
        match: (?:, +|\{ *)((["']?)(repository)(\2))(:)
        captures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: entity.other.repository.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}

      # multi-line (this is what you want)
      - name: meta.repository-block.yaml-tmlanguage
        begin: ^((["']?)(repository)(\2))(:)
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: entity.other.repository.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
        end: ^(?!\s*($|#))(?=\S)
        patterns:
          - include: '#comment'
          - include: '#repository-key'
          - include: '#repository'
          - include: '#name'
          - include: '#apply-end-pattern-last'

          # child scope
          - include: '#patterns'
          - include: '#captures'

          - include: '#name'
          - include: '#match'
          - include: '#include'
          - include: '#comment-from-key'
          - include: '#number-key'

          - include: '#comment'
          - include: '#flow-style'
          - include: '#anchor'
          - include: '#alias'
          - include: '#unmatched'
          - include: '#illegal'

  # in-block special keys
  name:
    name: meta.name.yaml-tmlanguage
    match: (?:, +|\{ *|^ {2,}|^ *- +)((["']?)(contentName|name)(\2))(:) +((["']?)[-\w\. $]*(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.name.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage string.other.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: punctuation.definition.string.yaml-tmlanguage}

  apply-end-pattern-last:
    name: meta.apply-end-pattern-last.yaml-tmlanguage
    match: (?:, +|\{ *|^ {2,}|^ *- +)((["']?)(applyEndPatternLast)(\2))(:) +([Tt]rue|[Ff]alse|[Yy]es|[Nn]o|[Oo](?:n|ff)|TRUE|FALSE|YES|NO|ON|OFF)
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.apply-end-pattern-last.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage constant.language.boolean.yaml-tmlanguage}

  author:
    name: meta.author.yaml-tmlanguage
    match: (?:,|\{ *|^)((["']?)(author)(\2))(:) +((["']?).*(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.name.author.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage string.other.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: punctuation.definition.string.yaml-tmlanguage}

  key-equivalent:
    name: meta.key-equivalent.yaml-tmlanguage
    match: (?:,|\{ *|^)((["']?)(keyEquivalent)(\2))(:) +((["']?).*(\7))
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.name.key-equivalent.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage string.other.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: punctuation.definition.string.yaml-tmlanguage}

  # firstLineMatch/foldingStartMarker/foldingStopMarker
  other-markers:
    patterns:
      # multi-line (block style)
      - name: meta.other-marker.block.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        begin: ^( *)?(?:- +)?((["']?)(firstLineMatch|foldingStartMarker|foldingStopMarker)(\3))(:) +([|>])(?=, |,$| +#| *$)
        beginCaptures:
          2: {name: string.other.yaml-tmlanguage}
          3: {name: punctuation.definition.string.yaml-tmlanguage}
          4: {name: keyword.control.name.other-marker.yaml-tmlanguage}
          5: {name: punctuation.definition.string.yaml-tmlanguage}
          6: {name: keyword.operator.assignment.yaml-tmlanguage}
          7: {name: keyword.control.block.yaml-tmlanguage}
        end: ^(?! *$|\1 )
        patterns:
          - include: '#comment'
          - include: '#regex'

      # single-line (quoted)
      - name: meta.other-marker.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        begin: (?:, +|\{ *|^ {2,}|^ *- +)?((["']?)(firstLineMatch|foldingStartMarker|foldingStopMarker)(\2))(:) +(["'])
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.name.other-marker.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
          6: {name: punctuation.definition.string.yaml-tmlanguage}
        end: \6(?!\6)
        endCaptures:
          0: {name: punctuation.definition.string.yaml-tmlanguage}
        patterns:
          - match: "''"
          - include: '#regex'

      # single-line (unquoted)
      - name: meta.other-marker.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        begin: (?:, +|\{ *|^ {2,}|^ *- +)?((["']?)(firstLineMatch|foldingStartMarker|foldingStopMarker)(\2))(:) +(?!["'])
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.name.other-marker.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
        end: (?=, |,$| +[#{\['"]| *$| *})
        patterns:
          - include: '#regex'

  match:
    patterns:
      # multi-line (block style)
      - name: meta.match.block.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        # I don't have a single fucking clue why but apparently removing
        # the empty capturing group BREAKS the regexp
        begin: ^( *)(?:-?( +)())((["']?)(match|begin|end)(\3))(:) +([|>](\d*)[-+]?)(?=, |,$| +#| *$)
        beginCaptures:
          4: {name: string.other.yaml-tmlanguage}
          5: {name: punctuation.definition.string.yaml-tmlanguage}
          6: {name: keyword.control.$3.yaml-tmlanguage}
          7: {name: punctuation.definition.string.yaml-tmlanguage}
          8: {name: keyword.operator.assignment.yaml-tmlanguage}
          9: {name: keyword.control.block.yaml-tmlanguage}
          10: {name: constant.numeric.indentation-indicator.yaml-tmlanguage}
        # must be indented by at least as much as the key line + 1 (+ 1 for the potential '-')
        end: ^(?! *$|\1\2  )
        patterns:
          - include: '#comment' # for comments after the "|" or ">"
          - include: '#regex'

      # single-line (quoted)
      - name: meta.match.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        begin: (?:, +|\{ *|^ {2,}|^ *- +)((["']?)(match|begin|end)(\2))(:) +(["'])
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.$3.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
          6: {name: punctuation.definition.string.yaml-tmlanguage}
        end: \6(?!\6)
        endCaptures:
          0: {name: punctuation.definition.string.yaml-tmlanguage}
        patterns:
          # Consume double-escaped single quotes so they won't interfere with the "end" match
          - match: "''"
          - match: '""'
          - include: '#regex'

      # single-line (unquoted)
      - name: meta.match.yaml-tmlanguage
        contentName: meta.value.yaml-tmlanguage
        begin: (?:, +|\{ *|^ {2,}|^ *- +)((["']?)(match|begin|end)(\2))(:)(?:(?= +#)| +(?!["'\[{]))
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.$3.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
        # This regexp is complex due to the many possibilities to terminate a string.
        end: (?=, |,$| +[#{\[]| *$| *})
        patterns:
          - include: '#regex'

  include:
    name: meta.include.yaml-tmlanguage
    match: | # example for multi-line match blocks (remember to escape " " spaces when using (?x))
      (?x)
      (?:,\ +|\{\ *|^\ {2,}|^\ *-\ +)
      ((["']?)(include)(\2))(:)\ +
      ((["'])(?:(\$self)
      |\#?([-\w\.\ ]*))(\7)
      |(\$self)
      |([-\w\.\ ]*)
      )
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: keyword.control.include.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.control.definition.yaml-tmlanguage}
      6: {name: meta.value.yaml-tmlanguage string.other.yaml-tmlanguage}
      7: {name: punctuation.definition.string.yaml-tmlanguage}
      8: {name: storage.modifier.self-include.yaml-tmlanguage}
      9: {name: variable.other.include.yaml-tmlanguage}
      10: {name: punctuation.definition.string.yaml-tmlanguage}
      11: {name: storage.modifier.self-include.yaml-tmlanguage}
      12: {name: variable.other.include.yaml-tmlanguage}

  comment-from-key:
    patterns:
      # block style
      - name: meta.comment-from-key.block.yaml-tmlanguage
        contentName: comment.block.from-key.block.yaml-tmlanguage
        comment: | # real comment
          block
          comment
        begin: ^( *)(?:- +)?((["']?)(comment)(\3))(:) +([|>](\d*)[-+]?)(?=, |,$| +#| *$)
        beginCaptures:
          2: {name: string.other.yaml-tmlanguage}
          3: {name: punctuation.definition.string.yaml-tmlanguage}
          4: {name: keyword.control.comment-from-key.yaml-tmlanguage}
          5: {name: punctuation.definition.string.yaml-tmlanguage}
          6: {name: keyword.operator.assignment.yaml-tmlanguage}
          7: {name: keyword.control.block.yaml-tmlanguage}
          8: {name: constant.numeric.indentation-indicator.yaml-tmlanguage}
        # must be indented by at least as much as the key line + 1
        end: ^(?! *$|\1 )

      # quoted
      # TODO: consider " and ' separately as they use different escape mechanisms actually
      - name: meta.comment-from-key.quoted.yaml-tmlanguage
        contentName: comment.block.from-key.quoted.yaml-tmlanguage
        comment: 'test comment
          over multiple lines?'
        begin: (?:, +|\{ *|^ *|^ *- +)((["']?)(comment)(\2))(:) +(?!\#)(["'])
        beginCaptures:
          1: {name: string.other.yaml-tmlanguage}
          2: {name: punctuation.definition.string.yaml-tmlanguage}
          3: {name: keyword.control.comment-from-key.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.operator.assignment.yaml-tmlanguage}
          6: {name: punctuation.definition.string.yaml-tmlanguage}
        end: (?<![^\\]\\)(\6)(?=, |,$| +#| *$| *})
        endCaptures:
          1: {name: punctuation.definition.string.yaml-tmlanguage}

      # unquoted
      - name: meta.comment-from-key.unquoted.yaml-tmlanguage
        contentName: comment.block.from-key.unquoted.yaml-tmlanguage
        comment: this is a "test" comment
          in another line # and this is a real comment
        begin: ^( *)(?:-( +))?((["']?)(comment)(\4))(:)[ ]
        beginCaptures:
          3: {name: string.other.yaml-tmlanguage}
          4: {name: punctuation.definition.string.yaml-tmlanguage}
          5: {name: keyword.control.comment-from-key.yaml-tmlanguage}
          6: {name: punctuation.definition.string.yaml-tmlanguage}
          7: {name: keyword.operator.assignment.yaml-tmlanguage}
        # Must be indented by at least as much as the key line + 1 - or terminated by :stuff:
        # Note1: can not differentiate if within inline ({) or block and thus
        # the inline terminating sequences which are valid in blocks are ignored completely.
        # Currently only interesting for "comment: no # still no"
        # Note2: Minimum indent is "  " if the comment key is not the first key in a list
        # (e.g. "- name: something\n  comment: dd"). Easiest workaroung.
        end: ^(?! *$|\1\2  ) #|(?<=.)(?=, |,$| +#| *(?<![^\\]\\)})

  # dict keys
  captures:
    name: meta.captures.yaml-tmlanguage
    match: (?:, +|\{ *|^ {2,}|^ *- +)((["']?)((?:(?:begin|end)C|c)aptures)(\2))(:)
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: entity.other.captures.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}

  patterns:
    name: meta.patterns.yaml-tmlanguage
    # "patterns" is one of the 2 keys that are also allowed (required) in global scope
    match: (?:, +|\{ *|^ *|^ *- +)((["']?)(patterns)(\2))(:)
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: support.type.patterns.patterns.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}

  # variable keys
  number-key:
    name: meta.number-key.yaml-tmlanguage
    match: (?:, +|\{ *|^ *)((["']?)(\d+)(\2))(:)
    captures:
      1: {name: string.other.yaml-tmlanguage}
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: constant.numeric.key.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}

  repository-key:
    # More like "any key with two leading spaces"
    name: meta.repository-key.yaml-tmlanguage
    match: (?:^  )((["']?)([-\w]+)(\2))(:)
    captures:
      #1: {name: string.other.yaml-tmlanguage} # "string variable" is assigned by certain color schemes
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: variable.other.repository-key.yaml-tmlanguage} # entity.name.section.repository-key.yaml-tmlanguage
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}

  repository-key-inline:
    # More like "any other key there is"
    name: meta.repository-key.yaml-tmlanguage
    match: (?:, +|\{ *)((["']?)([-\w]+)(\2))(:)
    captures:
      #1: {name: string.other.yaml-tmlanguage} # "string variable" is assigned by certain color schemes
      2: {name: punctuation.definition.string.yaml-tmlanguage}
      3: {name: variable.other.repository-key.yaml-tmlanguage}
      4: {name: punctuation.definition.string.yaml-tmlanguage}
      5: {name: keyword.operator.assignment.yaml-tmlanguage}

  flow-style:
    patterns:
      - begin: \{
        beginCaptures:
          0: {name: punctuation.definition.dictionary.begin.yaml-tmlanguage}
        end: \}
        endCaptures:
          0: {name: punctuation.definition.dictionary.end.yaml-tmlanguage}
        name: meta.flow-style.dictionary.yaml-tmlanguage
        patterns:
          - include: '#flow-style' # nested flow styles

          - include: '#include'
          - include: '#name'
          - include: '#match'
          - include: '#comment-from-key'
          - include: '#number-key'

          - include: '#comment'
          - include: '#repository'
          - include: '#name'
          - include: '#apply-end-pattern-last'

          # child scope
          - include: '#patterns'
          - include: '#captures'

          - include: '#comment'
          - include: '#anchor'
          - include: '#alias'
          - include: '#unmatched'
          - include: '#illegal'
      - begin: \[
        beginCaptures:
          0: {name: punctuation.definition.list.begin.yaml-tmlanguage}
        end: \]
        endCaptures:
          0: {name: punctuation.definition.list.end.yaml-tmlanguage}
        name: meta.flow-style.list.yaml-tmlanguage
        patterns:
          - include: '#flow-style' # nested flow styles

          - include: '#include'
          - include: '#name'
          - include: '#match'
          - include: '#comment-from-key'
          - include: '#number-key'

          - include: '#comment'
          - include: '#repository'
          - include: '#name'
          - include: '#apply-end-pattern-last'

          # child scope
          - include: '#patterns'
          - include: '#captures'

          - include: '#comment'
          - include: '#anchor'
          - include: '#alias'
          - include: '#unmatched'
          - include: '#illegal'

  anchor:
    name: variable.other.anchor.yaml-tmlanguage
    match: (&)([\w-]+)
    captures:
      1: {name: punctuation.definition.anchor.yaml-tmlanguage}
      2: {name: variable.other.anchor.yaml-tmlanguage}

  alias:
    name: variable.other.alias.yaml-tmlanguage
    match: (\*)([\w-]+)
    captures:
      1: {name: punctuation.definition.alias.yaml-tmlanguage}
      2: {name: variable.other.alias.yaml-tmlanguage}

  unmatched:
    # unmatched list entries (e.g. before "{") and commas before newlines
    match: ^ *- |,(?= *$| +#)

  illegal:
    name: invalid.illegal.unrecognized.yaml-tmlanguage
    match: '[^\s}]'

  regex:
    contentName: meta.regexp.yaml-tmlanguage

    patterns:
      - match: \|
        name: keyword.operator.alternation.regexp
      - match: \\[bB]
        name: keyword.control.anchor.regexp
      - match: \^|\\A
        name: keyword.control.begin.regexp
      - match: (?i)\$|\\[Zz]
        name: keyword.control.end.regexp
      - match: \\K
        name: keyword.control.keep-out.regexp
      - match: \\G
        name: keyword.control.search.regexp
      - match: (\\\d+)|(\\k[<'](-?\d+|\w+([-+]\d+)?)[>'])
        name: keyword.control.back-reference.regexp
        captures:
          1: {name: keyword.control.back-reference.regexp}
          2: {name: keyword.control.back-reference.regexp}
          3: {name: variable.other.regexp}
      - match: \\g[<'](-?\d+|\w+)[>']
        name: keyword.control.subroutine.regexp
        captures:
          1: {name: variable.other.regexp}
      - match: '[*+?]{1,2}|{\d+(,\d*)?}{1,2}'
        name: keyword.operator.quantifier.regexp
      - include: '#character_class'
      - include: '#character_property'
      - include: '#set'
      - begin: \(\?\#
        end: \)
        name: comment.block.regexp
        captures:
          0: {name: punctuation.definition.comment.block.regexp}
      - comment: Lookahead assertion
        begin: \(\?=
        end: \)
        name: meta.regexp.group.look-ahead.regexp
        captures:
          0: {name: punctuation.definition.group.look-ahead.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Lookbehind assertion
        begin: \(\?<=
        end: \)
        name: meta.regexp.group.look-behind.regexp
        captures:
          0: {name: punctuation.definition.group.look-behind.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Negative lookahead assertion
        begin: \(\?!
        end: \)
        name: meta.regexp.group.negative-look-ahead.regexp
        captures:
          0: {name: punctuation.definition.group.negative-look-ahead.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Negative lookbehind assertion
        begin: \(\?<!
        end: \)
        name: meta.regexp.group.negative-look-behind.regexp
        captures:
          0: {name: punctuation.definition.group.negative-look-behind.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Non-capturing group
        begin: '\(\?:'
        end: \)
        name: meta.regexp.group.non-capturing.regexp
        captures:
          0: {name: punctuation.definition.group.non-capturing.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Named capturing group
        begin: \(\?[<'](\w+)[>']
        end: \)
        name: meta.regexp.group.named-capturing
        beginCaptures:
          0: {name: punctuation.definition.group.named-capturing.regexp}
          1: {name: variable.other.regexp}
        endCaptures:
          0: {name: punctuation.definition.group.named-capturing.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Flag group
        begin: \(\?([imx]{,3})(-[imx]{1,3})?(?::(?!\))|(?=\)))
        end: \)
        name: meta.regexp.group.flag
        beginCaptures:
          0: {name: punctuation.definition.group.flag.regexp}
          1: {name: keyword.control.flag.regexp}
          2: {name: keyword.control.flag.regexp}
        endCaptures:
          0: {name: punctuation.definition.group.flag.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - comment: Atomic group
        begin: \(\?>
        end: \)
        name: meta.regexp.group.atomic.regexp
        captures:
          0: {name: punctuation.definition.group.atomic.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - begin: \(
        end: \)
        name: meta.regexp.group.capturing.regexp
        captures:
          0: {name: punctuation.definition.group.capturing.regexp}
        patterns:
          - include: '#comment'
          - include: '#regex'
      - include: '#special_escapes'
      - include: '#escaped_char'

  character_class:
    patterns:
      - match: (?i)\\[dswh]
        name: keyword.control.character-class.regexp
      - match: \.
        name: constant.character.all.regexp

  character_property:
    match: |
      (?x)
      \\(?:p\{\^?|P\{)(
        (?#all encodings)
        (?>Alnum|Alpha|Blank|Cntrl|Digit|Graph|Lower|
            Print|Punct|Space|Upper|XDigit|Word|ASCII)
        (?#EUC_JP, Shift_JIS)
        |(?>Hiragana|Katakana)
        (?#UTF8, UTF16, UTF32)
        |(?>Any|Assigned)
        |(?>C|Cc|Cf|Cn|Co|Cs|L|Ll|Lm|Lo|Lt|Lu|
            M|Mc|Me|Mn|N|Nd|Nl|No|P|Pc|Pd|Pe|Pf|Pi|Po|Ps|
            S|Sc|Sk|Sm|So|Z|Zl|Zp|Zs)
        |(?>Arabic|Armenian|Bengali|Bopomofo|Braille|Buginese|
            Buhid|Canadian_Aboriginal|Cherokee|Common|Coptic|
            Cypriot|Cyrillic|Deseret|Devanagari|Ethiopic|Georgian|
            Glagolitic|Gothic|Greek|Gujarati|Gurmukhi|Han|Hangul|
            Hanunoo|Hebrew|Hiragana|Inherited|Kannada|Katakana|
            Kharoshthi|Khmer|Lao|Latin|Limbu|Linear_B|Malayalam|
            Mongolian|Myanmar|New_Tai_Lue|Ogham|Old_Italic|Old_Persian|
            Oriya|Osmanya|Runic|Shavian|Sinhala|Syloti_Nagri|Syriac|
            Tagalog|Tagbanwa|Tai_Le|Tamil|Telugu|Thaana|Thai|Tibetan|
            Tifinagh|Ugaritic|Yi)
      )\}
    name: keyword.contol.character-property.regexp
    captures:
      1: {name: constant.other.property.regexp}

  escaped_char:
    match: \\.
    name: constant.character.escape.general.regexp

  set:
    begin: \[(\^?)
    end: \]
    name: string.regexp.set
    captures:
      0: {name: punctuation.definition.character-class.regexp}
      1: {name: keyword.operator.negation.regexp}
    patterns:
      - match: \[:\^?(?>alnum|alpha|ascii|blank|cntrl|digit|graph|lower|print|punct|space|upper|xdigit|word):\]
        name: constant.other.posix-bracket.regexp
      - include: '#set'
      - include: '#character_property'
      - include: '#character_class'
      - include: '#special_escapes'
      - include: '#escaped_char'
      - match: .-[^\]]
        name: constant.other.range.regexp
      - match: (?<!\[)&&(?!\])
        name: keyword.operator.intersection.regexp

  special_escapes:
    match: |
      (?x)\\
        ([tvnrbfae]   (?# general chars)
        |[0-8]{3}     (?# octal)
        |x\h\h        (?# hexadecimal)
        |x\{7\h{7}\}  (?# wide hexadecimal)
        |c\d+         (?# control char)
        |M-(\\C-)?\d+ (?# meta control char)
        |C-\d+        (?# control char 2)
      )
    name: constant.character.escape.regexp
    patterns:
      - match: \\c
        name: constant.character.escape.control.regexp
      - match: \\M-(\\C-)?
        name: constant.character.escape.meta.regexp
      - match: \\C-
        name: constant.character.escape.control.regexp
      - match: \\x
        name: constant.character.escape.hexadecimal.regexp
      - match: \\x\{7\h{7}\}
        name: constant.character.escape.wide-hexadecimal.regexp
      - match: \\[0-8]{3}
        name: constant.character.escape.octal.regexp
